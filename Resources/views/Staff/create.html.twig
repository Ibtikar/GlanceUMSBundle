{% extends 'IbtikarGlanceDashboardBundle::formLayout.html.twig' %}



{% block javascripts %}
    {{parent()}}

    <script>
        var countryCitiesOptionsUrl = '{{ path('ibtikar_glance_dashboard_backend_country_cities_options') }}';
        var url;
        var countriesNames ={{countries|raw}} ;
        var countryData = $.fn.intlTelInput.getCountryData();
        $.each(countryData, function (i, country) {
            country.name = countriesNames[country.iso2];
        });
        $.fn.intlTelInput.setCountryData(countryData);
        $("#staff_mobile_phone").intlTelInput({
            allowExtensions: true,
            autoFormat: true,
            autoHideDialCode: true,
            autoPlaceholder: true,
            defaultCountry: "sa",
            "initialCountry":'sa',
            nationalMode: true,
            numberType: "MOBILE",
            onlyCountries:{{ countryCodes|raw }},
            preferredCountries: []});


        function filterCitySelectByCountry() {
           $.ajax({
                   url: countryCitiesOptionsUrl + '?countryCode=' + $('#staff_country').val(),

                   success: function(data) {
                       var selectedValue = $('#staff_city').val();
                       $('#staff_city').html(data).select2('val', '');
                       var $oldSelectedOption = $('#staff_city option[value="' + selectedValue + '"]');
                       if($oldSelectedOption.length > 0) {
                           $oldSelectedOption.prop('selected', true);
                       }
                        $('#staff_city').trigger('change');

                   }
               });
                   }

                   jQuery(document).ready(function ($) {
                       filterCitySelectByCountry();

                       $('body').on('ajaxCallback', function () {

                           filterCitySelectByCountry();

                       });
                       $(document).on('change', '#staff_country', filterCitySelectByCountry);
                               filterCitySelectByCountry();

                               $('#staff_mobile_phone').on("countrychange", function (e, countryData) {
                                   $('#staff_mobile_phone').val('');
                               });
                               $('#staff_mobile_phone').on('blur', function () {
                                   $('#staff_mobile_phone').val($("#staff_mobile_phone").intlTelInput("getNumber", intlTelInputUtils.numberFormat.NATIONAL));
                               });

                       $('body').on('click', '[data-dismiss="fileupload"]', function () {
                           unhighlightElement($(this).closest('.fileupload').find('input:file').get(0));
                       });

                       //solve double click issue for upload plugin on ie
                       if (navigator.userAgent.indexOf("MSIE") > 0) {

                           $(document).livequery('#staff_file', function () {
                               $(this).bind('mousedown', function () {
                                   $(this).trigger('click');
                               });
                           });


                       }


                       $('body').on('preAjaxCallback', function () {
                          $('#staff_mobile_countryCode').val($("#staff_mobile_phone").intlTelInput("getSelectedCountryData").iso2);
                           $('.alert-danger').remove()

                       });
                   });
    </script>
{% endblock %}
